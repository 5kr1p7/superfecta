<?php
class Telepest_UK extends superfecta_base {

	function settings() {
		//configuration / display parameters
		//The description cannot contain "a" tags, but can contain limited HTML. Some HTML (like the a tags) will break the UI.
		$source_desc = "http://www.telepest.co.uk - A datasource devoted to identifying telemarketers. All information on this site is submitted by users. The operators of Telepest make no claims whatsoever regarding its accuracy or reliability.";
		$settings['desc'] = $source_desc;
		$settings['version_requirement'] = "3.0";

		$source_param = array();
		$source_param['Get_Caller_ID_Name']['desc'] = 'Use Telepest.co.uk for caller id name lookup.';
		$source_param['Get_Caller_ID_Name']['type'] = 'checkbox';
		$source_param['Get_Caller_ID_Name']['default'] = 'on';
		$source_param['Get_SPAM_Score']['desc'] = 'Use Telepest.co.uk for spam scoring.';
		$source_param['Get_SPAM_Score']['type'] = 'checkbox';
		$source_param['Get_SPAM_Score']['default'] = 'on';

		$settings['param'] = array();
		$settings['source_param'] = $source_param;

		return($settings);
	}
	
	function get_caller_id($thenumber,$run_param=array()) {
		//This debug variable allows simple copy and past of most sources.
		$debug = $this->debug;

		$caller_id = "";		

		if(($run_param['Get_SPAM_Score'] == 'on') || ($run_param['Get_Caller_ID_Name'] == 'on')) 
		{			
			if(!$this->IsValidNumber('UK', $thenumber))
			{
				if($debug)
				{
					print "Skipping Source - Non UK number: {$thenumber}<br>\n";
				}
			}
			else
			{
				if($debug)
				{
					print "Searching Telepest.co.uk ... ";
				}
				
				$url = "http://www.telepest.co.uk/$thenumber";
				$value = get_url_contents($url);
				
				$start = strpos($value, $thenumber.' is not in our database of possible telepests');
				if($start >0)
				{
					$caller_id=''; // Not a telepest
					if($debug)
					{
						print "not found<br>\n";
					}
				}
				else
				{
					$start = strpos($value, $thenumber.' has been reported as a possible telepest');
					if($start >0)
					{
						if($run_param['Get_SPAM_Score'] == 'on')
						{
							$this->spam = true;	// Reported as a telepest
							if($debug)
							{
								print "SPAM caller<br>\n";
							}
						}
						if($run_param['Get_Caller_ID_Name'] == 'on')
						{
							if($debug)
							{
								print "Looking up CNAM ... ";
							}
							$start = strpos($value, 'We have no information on the ownership of this number.');
							if($start == false)
							{
								$start = strpos($value, 'According to reports, this number is most likely to belong to');
								$value = substr($value,$start+62);
								$end = strpos($value,'</p>');
								$value = substr($value,0, $end);
								$caller_id = strip_tags($value);
							}
							else
							{
								$caller_id = '';	// Should leave blank ?
							}
						}
					}
				}
			}
		}			

		return($caller_id);
	}
}